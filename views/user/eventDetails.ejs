<%- include('../partials/userHeader', { user: user }) %>

<main class="ml-0 md:ml-60 p-4 md:p-8 bg-gray-100 min-h-screen">
  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6">

    <!-- Event Title -->
    <h2 class="text-3xl font-bold mb-4"><%= event.name %></h2>

    <!-- Event Department -->
    <p class="mb-2"><strong>Department:</strong> <%= event.department || 'All Departments' %></p>

    <!-- Event Images -->
    <% if(event.media && event.media.length > 0) { %>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <% event.media.forEach(img => { %>
          <img src="/uploads/<%= img %>" alt="Event Image" class="w-full h-48 object-cover rounded-lg">
        <% }) %>
      </div>
    <% } %>

    <!-- Event Details -->
    <p class="mb-2"><strong>Date:</strong> <%= event.date %></p>
    <p class="mb-2"><strong>Time:</strong> <%= event.time %></p>
    <p class="mb-2"><strong>Venue:</strong> <%= event.venue %></p>
    <p class="mb-2"><strong>Registration Fee:</strong> ₹<%= event.regFee %></p>
    <p class="mb-2"><strong>Participants Allowed:</strong> <%= event.participants %></p>
    <p class="mb-2"><strong>Contact Info:</strong> <%= event.contactInfo %></p>
    <p class="mb-4"><strong>Description:</strong> <%= event.description || 'No description provided' %></p>

    <!-- Registration / Status Section -->
    <div class="mt-6">
      <% if (!registration) { %>
        <!-- Not registered yet -->
        <form action="/user/event/<%= event._id %>/register" method="POST" class="space-y-6">
          <h3 class="text-2xl font-semibold mb-4">Register for Event</h3>

          <div id="participants-container">
            <!-- First participant (autofilled from user session if available) -->
            <div class="participant border p-4 rounded-lg mb-4 bg-gray-50">
              <h4 class="text-lg font-semibold mb-2">Participant 1 (You)</h4>

              <label class="block mb-2">Full Name</label>
              <input type="text" name="participants[0][name]" 
                    value="<%= user?.name || '' %>" 
                    class="w-full border rounded-lg p-2 mb-3" required>

              <label class="block mb-2">Email</label>
              <input type="email" name="participants[0][email]" 
                    value="<%= user?.email || '' %>" 
                    class="w-full border rounded-lg p-2 mb-3" required>

              <label class="block mb-2">Mobile Number</label>
              <input type="text" name="participants[0][mobNo]" 
                    value="<%= user?.mobile || '' %>" 
                    class="w-full border rounded-lg p-2 mb-3" required>

              <label class="block mb-2">Alternate Mobile (Optional)</label>
              <input type="text" name="participants[0][altMobNo]" 
                    class="w-full border rounded-lg p-2 mb-3">

              <label class="block mb-2">College</label>
              <input type="text" name="participants[0][college]" 
                    value="<%= user?.college || '' %>" 
                    class="w-full border rounded-lg p-2 mb-3" required>

              <label class="block mb-2">Branch</label>
              <input type="text" name="participants[0][branch]" 
                    value="<%= user?.branch || '' %>" 
                    class="w-full border rounded-lg p-2 mb-3" required>

              <label class="block mb-2">Semester</label>
              <input type="text" name="participants[0][semester]" 
                    value="<%= user?.semester || '' %>" 
                    class="w-full border rounded-lg p-2 mb-3" required>
            </div>
          </div>

          <!-- Add Participant Button (if multiple allowed) -->
          <% if(event.participants > 1) { %>
            <button type="button" id="add-participant-btn" 
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
              + Add Participant
            </button>
          <% } %>

          <!-- Submit Button -->
          <button type="submit" 
                  class="w-full px-6 py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600">
            Submit Registration
          </button>
        </form>

      <% } else if (registration.paymentStatus === "pending") { %>
        <!-- Already registered but payment pending -->
        <div class="p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded mb-4">
          <p class="text-yellow-700 font-medium">⚠ You have registered for this event but payment is pending.</p>
        </div>
        <a href="/user/event/<%= event._id %>/payment" 
          class="inline-block px-6 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700">
          Proceed to Payment
        </a>

      <% } else if (registration.paymentStatus === "paid") { %>
        <!-- Already paid -->
        <div class="p-4 bg-green-100 border-l-4 border-green-500 rounded">
          <p class="text-green-700 font-medium">✅ You are successfully registered for this event!</p>
        </div>
      <% } %>
    </div>

    <!-- Back Link -->
    <a href="/user/userDashboard" class="mt-6 inline-block text-blue-500 hover:underline">← Back to All Events</a>
  </div>
</main>

<script>
  const maxParticipants = <%= event.participants %>;
  const container = document.getElementById("participants-container");
  const addBtn = document.getElementById("add-participant-btn");

  let currentCount = 1;

  if (addBtn) {
    addBtn.addEventListener("click", () => {
      if (currentCount >= maxParticipants) return;

      const div = document.createElement("div");
      div.className = "participant border p-4 rounded-lg mb-4 bg-gray-50";
      div.innerHTML = `
        <h4 class="text-lg font-semibold mb-2">Participant ${currentCount + 1}</h4>

        <label class="block mb-2">Full Name</label>
        <input type="text" name="participants[${currentCount}][name]" class="w-full border rounded-lg p-2 mb-3" required>

        <label class="block mb-2">Email</label>
        <input type="email" name="participants[${currentCount}][email]" class="w-full border rounded-lg p-2 mb-3" required>

        <label class="block mb-2">Mobile Number</label>
        <input type="text" name="participants[${currentCount}][mobNo]" class="w-full border rounded-lg p-2 mb-3" required>

        <label class="block mb-2">Alternate Mobile (Optional)</label>
        <input type="text" name="participants[${currentCount}][altMobNo]" class="w-full border rounded-lg p-2 mb-3">

        <label class="block mb-2">College</label>
        <input type="text" name="participants[${currentCount}][college]" class="w-full border rounded-lg p-2 mb-3" required>

        <label class="block mb-2">Branch</label>
        <input type="text" name="participants[${currentCount}][branch]" class="w-full border rounded-lg p-2 mb-3" required>

        <label class="block mb-2">Semester</label>
        <input type="text" name="participants[${currentCount}][semester]" class="w-full border rounded-lg p-2 mb-3" required>
      `;

      container.appendChild(div);
      currentCount++;

      if (currentCount >= maxParticipants) {
        addBtn.disabled = true;
        addBtn.classList.add("opacity-50", "cursor-not-allowed");
      }
    });
  }
</script>
